name: Deploy PWA

on:
  push:
    branches: [main]
    paths:
      - 'apps/mobile/**'
      - 'infrastructure/pwa/**'
      - '.github/workflows/deploy-pwa.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build web export
        working-directory: apps/mobile
        run: npx expo export --platform web

      - name: Generate service worker
        working-directory: apps/mobile
        run: npx workbox-cli generateSW workbox-config.js

      - name: Copy PWA assets to dist
        working-directory: apps/mobile
        run: |
          cp public/manifest.json dist/
          cp public/sw-register.js dist/
          cp public/icon-192.png dist/
          cp public/icon-512.png dist/
          mkdir -p dist/.well-known
          cp ../../infrastructure/pwa/assetlinks.json dist/.well-known/assetlinks.json

      - name: Export native update bundle
        working-directory: apps/mobile
        run: npx expo export --platform android --output-dir native-updates

      - name: Deploy to VPS
        working-directory: apps/mobile
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${VPS_PORT:-4491}" -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # Clean old dist and upload new one
          ssh -p "${VPS_PORT:-4491}" "${VPS_USER}@${VPS_HOST}" "rm -rf /opt/agripro-pwa/dist/*"
          scp -P "${VPS_PORT:-4491}" -r dist/* "${VPS_USER}@${VPS_HOST}:/opt/agripro-pwa/dist/"

          # Clean old native updates and upload new ones
          ssh -p "${VPS_PORT:-4491}" "${VPS_USER}@${VPS_HOST}" "mkdir -p /opt/agripro-pwa/updates && rm -rf /opt/agripro-pwa/updates/*"
          scp -P "${VPS_PORT:-4491}" -r native-updates/* "${VPS_USER}@${VPS_HOST}:/opt/agripro-pwa/updates/"

          # Upload Caddyfile
          scp -P "${VPS_PORT:-4491}" ../../infrastructure/pwa/Caddyfile "${VPS_USER}@${VPS_HOST}:/opt/agripro-pwa/Caddyfile"

          # Reload Caddy (graceful)
          ssh -p "${VPS_PORT:-4491}" "${VPS_USER}@${VPS_HOST}" "docker exec agripro-pwa caddy reload --config /etc/caddy/Caddyfile 2>/dev/null || docker restart agripro-pwa"
