# Automated Coolify Deployment for AgriScheme Pro

This directory contains fully automated deployment scripts for deploying AgriScheme Pro to a Coolify instance on OVHcloud VPS.

## Quick Start

### Prerequisites

1. A fresh Ubuntu 22.04 LTS VPS from OVHcloud
2. SSH access to the server (ubuntu user)
3. SSH key for authentication
4. (Optional) A domain name with DNS access

### One-Command Deployment

**With Domain:**
```bash
./scripts/deploy/deploy.sh <SERVER_IP> <DOMAIN> <SSH_KEY_PATH>
```

**Without Domain (IP-only):**
```bash
./scripts/deploy/deploy.sh <SERVER_IP> "" <SSH_KEY_PATH>
```

Examples:
```bash
# With domain
./scripts/deploy/deploy.sh 51.178.42.123 agrischeme.com ~/.ssh/id_rsa

# IP-only deployment
./scripts/deploy/deploy.sh 51.178.42.123 "" ~/.ssh/id_ed25519
```

## Deployment Modes

### IP-Only Mode (No Domain Required)

Perfect for testing or when you don't have a domain yet:
- ✅ No DNS configuration needed
- ✅ Access via IP:PORT
- ✅ All features work except HTTPS/SSL
- ✅ Can add domain later

```bash
./scripts/deploy/deploy.sh 213.32.19.116 "" ~/.ssh/id_ed25519
```

Access:
- Coolify UI: `http://213.32.19.116:8000`
- Services: `http://213.32.19.116:<assigned-port>`

### Domain-Based Mode

Full production deployment with SSL:
- ✅ Custom domains for each service
- ✅ Automatic SSL certificates
- ✅ Professional URLs
- ⚠️ Requires DNS configuration

```bash
./scripts/deploy/deploy.sh 213.32.19.116 agrischeme.com ~/.ssh/id_ed25519
```

Access:
- Coolify UI: `https://coolify.agrischeme.com`
- Services: `https://auth.api.agrischeme.com`, etc.

## What Gets Deployed

The automated deployment will:

1. ✓ Configure server (firewall, updates, security)
2. ✓ Install and configure Coolify
3. ✓ Set up DNS (if domain provided)
4. ✓ Deploy 10 PostgreSQL databases
5. ✓ Deploy Redis
6. ✓ Deploy Kafka cluster
7. ✓ Create Coolify project structure
8. ✓ Configure monitoring (Prometheus + Grafana)
9. ✓ Set up automated backups
10. ✓ Deploy all 15 microservices
11. ✓ Run database migrations
12. ✓ Configure API gateway routing

## Manual Steps Required

### IP-Only Deployment
1. **Coolify Setup** - Complete initial setup wizard (3 minutes)
2. **GitHub Integration** - Connect repository (2 minutes)

### Domain-Based Deployment
1. **DNS Configuration** - Add A records (2 minutes)
2. **Coolify Setup** - Complete initial setup wizard (3 minutes)
3. **GitHub Integration** - Connect repository (2 minutes)

## Scripts Overview

| Script | Purpose |
|--------|---------|
| `deploy.sh` | Main orchestration script |
| `01-server-setup.sh` | Server initialization and security |
| `02-install-coolify.sh` | Coolify installation |
| `03-configure-dns.sh` | DNS configuration helper (skipped in IP-only mode) |
| `04-deploy-databases.sh` | PostgreSQL database deployment |
| `05-deploy-infrastructure.sh` | Redis, Kafka deployment |
| `06-deploy-services.sh` | Microservice deployment |
| `07-configure-monitoring.sh` | Prometheus + Grafana setup |
| `08-run-migrations.sh` | Database migrations |
| `utils/` | Helper functions and utilities |

## Configuration

Edit `config/deployment.env` to customize:

```bash
# Server Configuration
SERVER_USER=ubuntu
SSH_PORT=22

# Database Configuration
POSTGRES_VERSION=16
POSTGRES_USER=agrischeme_admin
POSTGRES_PASSWORD=<auto-generated>

# Service Configuration
SERVICES_TO_DEPLOY=(auth farmer farm financial gis market ai iot livestock task inventory notification traceability compliance integration)

# Monitoring
ENABLE_MONITORING=true
```

## Deployment Phases

### Phase 1: Server Setup (5 minutes)
- System updates
- Firewall configuration
- Docker installation
- Security hardening

### Phase 2: Coolify Installation (5 minutes)
- Coolify installation
- Initial configuration
- SSL setup (if domain provided)

### Phase 3: DNS Configuration (2 minutes) - Optional
- Skipped in IP-only mode
- DNS setup wizard if domain provided

### Phase 4: Infrastructure (10 minutes)
- 10 PostgreSQL containers
- Redis cluster
- Kafka + Zookeeper

### Phase 5: Services (20 minutes)
- 15 FastAPI microservices
- Environment variables
- Health checks

### Phase 6: Finalization (5 minutes)
- Database migrations
- Monitoring setup
- Backup configuration

**Total Time:**
- IP-only: ~40 minutes
- With domain: ~50 minutes

## Troubleshooting

### SSH Connection Failed

```bash
# Test SSH connection
ssh ubuntu@<SERVER_IP>

# Copy SSH key if needed
ssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@<SERVER_IP>
```

### Check deployment status
```bash
./scripts/deploy/status.sh <SERVER_IP> <SSH_KEY_PATH>
```

### View logs
```bash
./scripts/deploy/logs.sh <SERVER_IP> <SERVICE_NAME>
```

## Security Notes

- All passwords are generated automatically and stored in `.secrets/` (gitignored)
- SSH key authentication is required
- Firewall is configured to allow only necessary ports
- SSL certificates are automatically provisioned via Let's Encrypt (domain mode only)

## Migrating from IP-Only to Domain

1. Configure DNS records for your domain
2. In Coolify UI, update each service's domain settings
3. Enable SSL certificates

No redeployment needed!

## Support

For issues or questions:
- GitHub Issues: https://github.com/jajuok/agripro/issues

---

**Time to Production:**
- IP-only: ~40 minutes
- With domain: ~50 minutes
