events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # API Gateway Server
    server {
        listen 8888;
        server_name _;

        # Docker internal DNS resolver - re-resolves every 10s
        # This is what makes container name resolution work
        resolver 127.0.0.11 valid=10s ipv6=off;

        # Prevent nginx from auto-adding trailing slash redirects for proxy locations
        # This avoids 301 redirects that break POST requests
        absolute_redirect off;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "Gateway healthy\n";
            add_header Content-Type text/plain;
        }

        # Auth Service - Health check (exact match)
        location = /api/v1/auth/health {
            set $auth_backend http://auth-service:8000;
            proxy_pass $auth_backend/health;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - All other auth routes
        location /api/v1/auth/ {
            set $auth_backend http://auth-service:8000;
            proxy_pass $auth_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Farmer Service - exact match for collection root (POST /api/v1/farmers)
        location = /api/v1/farmers {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Farmer Service - sub-paths
        location /api/v1/farmers/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Farms - exact match for collection root
        location = /api/v1/farms {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/farms/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/kyc/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/documents/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/farm-registration/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Crop Planning Service (on farmer service)
        location /api/v1/crop-planning/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Eligibility Service (on farmer service)
        location /api/v1/eligibility/ {
            set $farmer_backend http://farmer-service:8000;
            proxy_pass $farmer_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # GIS Service
        location /api/v1/gis/ {
            set $gis_backend http://gis-service:8000;
            proxy_pass $gis_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Financial Service
        location /api/v1/financial/ {
            set $financial_backend http://financial-service:8000;
            proxy_pass $financial_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Market Service
        location /api/v1/market/ {
            set $market_backend http://market-service:8000;
            proxy_pass $market_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # AI Service
        location /api/v1/ai/ {
            set $ai_backend http://ai-service:8000;
            proxy_pass $ai_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # IoT Service
        location /api/v1/iot/ {
            set $iot_backend http://iot-service:8000;
            proxy_pass $iot_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Livestock Service
        location /api/v1/livestock/ {
            set $livestock_backend http://livestock-service:8000;
            proxy_pass $livestock_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Task Service
        location /api/v1/tasks/ {
            set $task_backend http://task-service:8000;
            proxy_pass $task_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Inventory Service
        location /api/v1/inventory/ {
            set $inventory_backend http://inventory-service:8000;
            proxy_pass $inventory_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification Service
        location /api/v1/notifications/ {
            set $notification_backend http://notification-service:8000;
            proxy_pass $notification_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Traceability Service
        location /api/v1/traceability/ {
            set $traceability_backend http://traceability-service:8000;
            proxy_pass $traceability_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Compliance Service
        location /api/v1/compliance/ {
            set $compliance_backend http://compliance-service:8000;
            proxy_pass $compliance_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Integration Service
        location /api/v1/integration/ {
            set $integration_backend http://integration-service:8000;
            proxy_pass $integration_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Farm Service (lower priority - must be after /api/v1/farms/)
        location /api/v1/farm/ {
            set $farm_backend http://farm-service:8000;
            proxy_pass $farm_backend$request_uri;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default response for unknown paths
        location / {
            return 404 '{"error":"Not Found","message":"Invalid API endpoint"}';
            add_header Content-Type application/json;
        }
    }
}
